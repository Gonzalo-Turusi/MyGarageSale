@using MyGarageSale.Services
@inject ICartService CartService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IDisposable
@rendermode InteractiveServer

@if (cartCount > 0 && !isOnCartPage && !isOnAdminPage)
{
    <div class="fixed bottom-4 right-4 sm:bottom-6 sm:right-6 z-50 animate-bounce-in">
        <button @onclick="@(() => GoToCart())" 
                class="relative bg-blue-600 hover:bg-blue-700 text-white p-3 sm:p-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-blue-300 animate-pulse-slow"
                aria-label="Ver carrito de compras (@cartCount productos)">
            <!-- Icono del carrito -->
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5m0 0h8m-8 0a2 2 0 100 4 2 2 0 000-4zm8 0a2 2 0 100 4 2 2 0 000-4z">
                </path>
            </svg>
            
            <!-- Badge con el número de productos -->
            <span class="absolute -top-1 -right-1 sm:-top-2 sm:-right-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 sm:h-6 sm:w-6 flex items-center justify-center border-2 border-white shadow-md">
                @cartCount
            </span>
            
            <!-- Texto opcional para pantallas más grandes -->
            <span class="sr-only">Ver carrito (@cartCount productos)</span>
        </button>
        
        <!-- Tooltip opcional -->
        <div class="absolute bottom-full right-0 mb-2 opacity-0 hover:opacity-100 transition-opacity duration-200 pointer-events-none">
            <div class="bg-gray-800 text-white text-xs rounded py-1 px-2 whitespace-nowrap">
                Ver carrito (@cartCount @(cartCount == 1 ? "producto" : "productos"))
            </div>
        </div>
    </div>
}

@code {
    private int cartCount = 0;
    private bool isOnCartPage = false;
    private bool isOnAdminPage = false;
    
    protected override void OnInitialized()
    {
        CartService.OnCartUpdated += UpdateCartCount;
        Navigation.LocationChanged += OnLocationChanged;
        
        UpdateCartCount();
        CheckCurrentPage();
    }
    
    private void UpdateCartCount()
    {
        cartCount = CartService.GetCartCount();
        InvokeAsync(StateHasChanged);
    }
    
    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        CheckCurrentPage();
    }
    
    private void CheckCurrentPage()
    {
        var currentUri = Navigation.Uri;
        isOnCartPage = currentUri.EndsWith("/cart", StringComparison.OrdinalIgnoreCase);
        isOnAdminPage = currentUri.Contains("/admin", StringComparison.OrdinalIgnoreCase);
        InvokeAsync(StateHasChanged);
    }
    
    private async Task GoToCart()
    {
        Navigation.NavigateTo("/cart");
        // Hacer scroll al inicio de la página después de navegar
        await Task.Delay(100); // Pequeña pausa para asegurar que la navegación complete
        await JSRuntime.InvokeVoidAsync("window.scrollTo", 0, 0);
    }
    
    public void Dispose()
    {
        CartService.OnCartUpdated -= UpdateCartCount;
        Navigation.LocationChanged -= OnLocationChanged;
    }
} 